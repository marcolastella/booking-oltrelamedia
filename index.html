<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Booking App</title>
    <style>
        /* --- RESET E VARIABILI --- */
        * { box-sizing: border-box; }
        
        body {
            background-color: #050505;
            background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #000000 100%);
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
        }

        /* --- STILE VETRO --- */
        .glass-panel {
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            transition: all 0.3s ease;
        }

        /* --- BOTTONI --- */
        .btn {
            padding: 10px 20px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .btn:active { transform: scale(0.96); }

        .btn-primary { background: #ffffff; color: #000000; }
        .btn-primary:hover { background: #e0e0e0; }

        .btn-secondary { background: rgba(255, 255, 255, 0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.2); }

        .btn-danger { background: rgba(255, 59, 48, 0.2); color: #ff453a; border: 1px solid rgba(255, 59, 48, 0.3); }
        
        .btn-success { background: rgba(48, 209, 88, 0.2); color: #30D158; border: 1px solid rgba(48, 209, 88, 0.3); }

        /* --- INPUT & LABELS --- */
        .input-group { margin-bottom: 15px; }
        .input-label {
            display: block; font-size: 11px; color: #aaa; margin-bottom: 6px;
            font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
        }
        input, select, textarea {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 12px;
            color: white;
            width: 100%;
            font-size: 15px;
            outline: none;
            font-family: inherit;
        }
        input:focus, select:focus, textarea:focus { border-color: #007AFF; background: rgba(0,0,0,0.8); }

        /* --- VISTE --- */
        .view { display: none; width: 100%; max-width: 1200px; padding: 20px; animation: fadeIn 0.4s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- LOGIN --- */
        #login-view { max-width: 400px; text-align: center; padding: 40px; }
        .login-logo { font-size: 28px; font-weight: 800; margin-bottom: 5px; letter-spacing: -1px; }

        /* --- DASHBOARD --- */
        .grid-container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;
        }
        .date-card { padding: 25px; position: relative; cursor: pointer; transition: transform 0.2s; border-left: 5px solid #555; }
        .date-card:hover { transform: translateY(-5px); border-color: white; }

        /* --- SLOT LIST --- */
        .slot-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .slot-booked { border-left: 3px solid #FF3B30; background: rgba(255, 59, 48, 0.05); }
        .slot-free { border-left: 3px solid #30D158; }

        /* --- NOTE PRODUZIONE / CODA --- */
        .note-header {
            display: grid;
            grid-template-columns: 80px 2fr 1fr 1fr 100px 250px;
            gap: 15px; padding: 10px 0; border-bottom: 2px solid rgba(255,255,255,0.2);
            color: #aaa; font-size: 12px; text-transform: uppercase; font-weight: 600;
        }
        .note-item {
            display: grid;
            grid-template-columns: 80px 2fr 1fr 1fr 100px 250px;
            gap: 15px; padding: 20px 0; border-bottom: 1px solid rgba(255,255,255,0.1);
            align-items: center;
        }
        .edit-item {
            display: flex; flex-direction: column; background: rgba(255,255,255,0.03);
            border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05);
        }
        .edit-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .copy-box {
            background: rgba(0,0,0,0.4); padding: 10px; border-radius: 8px; border: 1px solid #333;
            font-family: monospace; font-size: 12px; cursor: pointer; transition: background 0.2s; position: relative;
        }
        .copy-box:hover { background: rgba(0,0,0,0.6); border-color: #555; }
        .copy-box::after { content: 'COPIA'; position: absolute; right: 10px; top: 10px; font-size: 9px; color: #007AFF; font-weight: bold; }
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 11px; text-transform: uppercase; font-weight: bold; display: inline-block; }
        .status-queue { background: rgba(255, 59, 48, 0.2); color: #ff453a; }
        .status-waiting { background: rgba(255, 214, 10, 0.2); color: #FFD60A; }
        .status-ready { background: rgba(48, 209, 88, 0.2); color: #30D158; }
        .status-archived { background: rgba(128, 128, 128, 0.2); color: #ccc; }

        @media (max-width: 900px) {
            .note-header { display: none; }
            .note-item { grid-template-columns: 1fr; gap: 10px; background: rgba(255,255,255,0.05); margin-bottom: 15px; padding: 15px; border-radius: 12px; border: none; }
        }

        /* --- MODAL --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; justify-content: center; align-items: center; }
        .modal-box { background: #1c1c1e; padding: 30px; border-radius: 20px; width: 90%; max-width: 600px; border: 1px solid #444; position: relative; max-height: 90vh; overflow-y: auto; }

        /* --- UTILS --- */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 16px; }
        .badge { font-size: 11px; padding: 4px 8px; border-radius: 4px; background: #333; margin-left: 8px; vertical-align: middle; }
        .user-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body>

    <!-- VISTA LOGIN -->
    <div id="login-view" class="view active glass-panel">
        <div class="login-logo">PRODUCTION APP</div>
        <p style="color:#888; margin-bottom:30px; font-size:14px;">Inserisci le tue credenziali</p>
        
        <form onsubmit="event.preventDefault(); handleLogin();">
            <input type="text" id="username" placeholder="Username" autocomplete="off">
            <input type="password" id="password" placeholder="Password">
            <button type="submit" class="btn btn-primary" style="width:100%; margin-top:10px;">ACCEDI</button>
        </form>
        <div id="login-msg" style="color: #FF3B30; margin-top: 15px; font-size:13px; font-weight:bold;"></div>
        <div style="margin-top:40px; border-top:1px solid rgba(255,255,255,0.1); padding-top:15px; font-size:11px; color:#555;">
            Stato Server: <span id="db-status" style="color:#FFD60A;">Connessione...</span><br>Modalit√† Cloud Online
        </div>
    </div>

    <!-- VISTA DASHBOARD -->
    <div id="dashboard-view" class="view">
        <header>
            <div>
                <span id="user-welcome" style="font-size:18px; font-weight:700;"></span>
                <span id="user-badge" class="badge"></span>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
                <button class="btn btn-secondary" onclick="openEditingQueue()" style="border-color:#FF3B30; color:#FF3B30;">üé¨ Coda Montaggio</button>
                <button class="btn" style="background:#333; color:white; font-size:12px;" onclick="handleLogout()">Esci</button>
            </div>
        </header>

        <!-- PANNELLO ADMIN -->
        <div id="admin-tools" class="glass-panel" style="display:none; padding:20px; margin-bottom:30px; border: 1px solid #FFD60A;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
                <div style="font-size:12px; font-weight:bold; color:#FFD60A; text-transform:uppercase;">Nuova Disponibilit√†</div>
                <div style="display:flex; gap:5px; flex-wrap:wrap;">
                    <button class="btn btn-secondary" onclick="openUserManager()" style="font-size:11px; padding:8px 12px;">üë• Utenti</button>
                    <button class="btn btn-secondary" onclick="openSettings()" style="font-size:11px; padding:8px 12px;">‚öôÔ∏è Configurazioni</button>
                    <button class="btn btn-secondary" onclick="openArchive()" style="font-size:11px; padding:8px 12px;">üìÇ Archivio</button>
                    <button class="btn btn-secondary" onclick="openProductionNotes()" style="font-size:11px; padding:8px 12px; border-color:#00C7BE; color:#00C7BE;">üìã Note Prod.</button>
                </div>
            </div>
            
            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:end;">
                <div style="flex:1; min-width:140px;">
                    <label class="input-label">Giorno</label>
                    <input type="date" id="new-date" style="margin:0;">
                </div>
                <div style="flex:1; min-width:140px;">
                    <label class="input-label">Redazione</label>
                    <select id="new-team" style="margin:0;"><!-- Popolato da JS --></select>
                </div>
                <div style="flex:2; min-width:200px;">
                    <label class="input-label">Fascia Oraria</label>
                    <div style="display:flex; gap:5px; align-items:center; background:rgba(0,0,0,0.5); padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.2);">
                        <input type="time" id="start-time" value="09:00" style="margin:0; width:auto; background:none; border:none; color:white; padding:0;">
                        <span style="font-size:12px; color:#aaa;">-</span>
                        <input type="time" id="end-time" value="18:00" style="margin:0; width:auto; background:none; border:none; color:white; padding:0;">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="createAllocation()">+ Crea</button>
            </div>
            <div style="font-size:11px; color:#666; margin-top:8px;">* Genera slot ogni 30 min.</div>
        </div>

        <h2 id="dash-title" style="font-size:24px; margin-bottom:10px;">Calendario</h2>
        <div id="grid-dates" class="grid-container"></div>
    </div>

    <!-- VISTA NOTE PRODUZIONE -->
    <div id="production-notes-view" class="view">
        <header>
            <button class="btn" style="background:transparent; border:1px solid #555; color:#ccc;" onclick="goToDashboard()">‚Üê Indietro</button>
            <span style="font-size:18px; font-weight:700;">Note di Produzione (Oggi)</span>
        </header>
        <div class="glass-panel" style="padding:20px; min-height:400px;">
            <div class="note-header">
                <div>Orario</div>
                <div>Ospite / Azienda</div>
                <div>Format</div>
                <div>Giornalista</div>
                <div style="text-align:center;">Modalit√†</div>
                <div style="text-align:center;">Azioni</div>
            </div>
            <div id="notes-list"></div>
        </div>
    </div>

    <!-- VISTA CODA MONTAGGIO -->
    <div id="editing-queue-view" class="view">
        <header>
            <button class="btn" style="background:transparent; border:1px solid #555; color:#ccc;" onclick="goToDashboard()">‚Üê Indietro</button>
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:18px; font-weight:700;">Coda di Montaggio</span>
                <button class="btn btn-secondary" style="font-size:11px; padding:6px 12px;" onclick="openEditingArchive()">üìÇ Archivio</button>
            </div>
        </header>
        <div class="glass-panel" style="padding:20px; min-height:400px;"><div id="editing-list"></div></div>
    </div>

    <!-- VISTA ARCHIVIO MONTAGGIO (NUOVA) -->
    <div id="editing-archive-view" class="view">
        <header>
            <button class="btn" style="background:transparent; border:1px solid #555; color:#ccc;" onclick="openEditingQueue()">‚Üê Coda Montaggio</button>
            <span style="font-size:18px; font-weight:700;">Archivio Montaggi Completati</span>
        </header>
        <div class="glass-panel" style="padding:20px; min-height:400px;"><div id="editing-archive-list"></div></div>
    </div>

    <!-- VISTA ARCHIVIO REGISTRAZIONI -->
    <div id="archive-view" class="view">
        <header>
            <button class="btn" style="background:transparent; border:1px solid #555; color:#ccc;" onclick="goToDashboard()">‚Üê Indietro</button>
            <span style="font-size:18px; font-weight:700;">Archivio Registrazioni</span>
        </header>
        <div id="grid-archive" class="grid-container"></div>
    </div>

    <!-- VISTA SLOT -->
    <div id="slots-view" class="view">
        <header>
            <button class="btn" style="background:transparent; border:1px solid #555; color:#ccc;" onclick="goToDashboard()">‚Üê Indietro</button>
            <div style="text-align:right;">
                <div id="slot-date-title" style="font-weight:700; font-size:16px;"></div>
                <div id="slot-team-subtitle" style="font-size:12px; opacity:0.7;"></div>
            </div>
        </header>
        <div id="slots-container" class="glass-panel" style="padding:0 20px;"></div>
    </div>

    <!-- MODALE NOTE PRODUZIONE -->
    <div id="prod-note-modal" class="modal-overlay">
        <div class="modal-box glass-panel">
            <h3 style="margin-top:0;">Appunti di Regia</h3>
            <textarea id="prod-note-text" rows="5" placeholder="Scrivi qui note per il montaggio..." style="width:100%;"></textarea>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
                <button class="btn" style="background:transparent;" onclick="document.getElementById('prod-note-modal').style.display='none'">Annulla</button>
                <button class="btn btn-primary" onclick="saveProdNote()">Salva Note</button>
            </div>
        </div>
    </div>

    <!-- MODALE GESTIONE UTENTI (ADMIN) -->
    <div id="users-modal" class="modal-overlay">
        <div class="modal-box glass-panel" style="max-width:800px;">
            <h3 style="margin-top:0;">Gestione Utenti & Accessi</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:10px;">
                    <h4 style="margin-top:0;">Aggiungi / Modifica</h4>
                    <div class="input-group"><label class="input-label">Username (Login)</label><input type="text" id="u-user" placeholder="es. redazione1"></div>
                    <div class="input-group"><label class="input-label">Password</label><input type="text" id="u-pass" placeholder="Password"></div>
                    <div class="input-group"><label class="input-label">Nome Visualizzato</label><input type="text" id="u-label" placeholder="es. Redazione Sport"></div>
                    <div class="input-group"><label class="input-label">Colore</label><input type="color" id="u-color" value="#007AFF" style="height:40px;"></div>
                    <button class="btn btn-primary" onclick="saveUserConfig()" style="width:100%;">Salva Utente</button>
                </div>
                <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:10px; max-height:300px; overflow-y:auto;">
                    <h4 style="margin-top:0;">Utenti Attivi</h4>
                    <div id="users-list-container"></div>
                </div>
            </div>
            <div style="text-align:right;"><button class="btn" style="background:transparent; color:#888;" onclick="closeUserManager()">Chiudi</button></div>
        </div>
    </div>

    <!-- MODALE IMPOSTAZIONI (LISTE) -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-box glass-panel" style="max-width:800px; max-height:90vh; overflow-y:auto;">
            <h3 style="margin-top:0; margin-bottom:20px; color:#FFD60A;">‚öôÔ∏è Configurazioni Liste</h3>
            <p style="font-size:12px; color:#aaa; margin-bottom:15px;">Inserisci un elemento per riga.</p>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div>
                    <label class="input-label">Redazioni (Men√π Assegnazione)</label>
                    <textarea id="set-teams" rows="8" placeholder="Touchpoint&#10;Insurzine..."></textarea>
                </div>
                <div>
                    <label class="input-label">Formats</label>
                    <textarea id="set-formats" rows="8" placeholder="Talk Show..."></textarea>
                </div>
                <div>
                    <label class="input-label">Giornalisti</label>
                    <textarea id="set-jours" rows="8" placeholder="Mario Rossi..."></textarea>
                </div>
                <div>
                    <label class="input-label">Commerciali</label>
                    <textarea id="set-sales" rows="8" placeholder="Anna Bianchi..."></textarea>
                </div>
            </div>

            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                <button class="btn" style="background:transparent; color:#888;" onclick="closeSettings()">Annulla</button>
                <button class="btn btn-primary" onclick="saveSettings()">Salva Configurazioni</button>
            </div>
        </div>
    </div>

    <!-- MODALE PRENOTAZIONE -->
    <div id="booking-modal" class="modal-overlay">
        <div class="modal-box glass-panel">
            <h3 style="margin-top:0; margin-bottom:20px;">
                <span id="modal-title-action">Prenota</span> Slot 
                <span id="modal-time" style="color:#007AFF;"></span>
            </h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div class="input-group"><label class="input-label">Ospite</label><input type="text" id="b-name"></div>
                <div class="input-group"><label class="input-label">Azienda</label><input type="text" id="b-company"></div>
            </div>
            <div class="input-group"><label class="input-label">Job Title</label><textarea id="b-job" rows="1"></textarea></div>
            <div class="input-group"><label class="input-label">Format</label><select id="b-format"><option value="">Seleziona...</option></select></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div class="input-group"><label class="input-label">Giornalista</label><select id="b-jour"><option value="">Seleziona...</option></select></div>
                <div class="input-group"><label class="input-label">Commerciale</label><select id="b-sales"><option value="">Seleziona...</option></select></div>
            </div>
            <div class="input-group"><label class="input-label">Modalit√†</label><select id="b-type"><option value="Presenza">In Presenza</option><option value="Remoto">In Remoto</option></select></div>
            <div class="input-group"><label class="input-label">Note</label><textarea id="b-note" rows="2"></textarea></div>
            <div style="display:flex; justify-content:space-between; margin-top:25px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">
                <button id="btn-delete" type="button" class="btn" style="background:transparent; color:#ff453a; border:1px solid #444; display:none;" onclick="deleteFromModal()">üóë Elimina</button>
                <div style="display:flex; gap:10px; margin-left:auto;">
                    <button type="button" class="btn" style="background:transparent; color:#888;" onclick="closeModal()">Annulla</button>
                    <button type="button" class="btn btn-primary" onclick="saveBooking()">Salva</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const manualConfig = {
            apiKey: "AIzaSyAh6TX5OhGoGSYLnK2fgxv5qqkQStL81f4",
            authDomain: "booking-redazioni-cb450.firebaseapp.com",
            projectId: "booking-redazioni-cb450",
            storageBucket: "booking-redazioni-cb450.firebasestorage.app",
            messagingSenderId: "201284623978",
            appId: "1:201284623978:web:0f7b3c93a2993da9883413",
            measurementId: "G-CEY9K09ZQY"
        };

        let firebaseConfig;
        let db;
        let auth;
        let isFirebaseActive = false;

        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                window.getCollectionRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'allocations');
                window.getSettingsRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'settings');
            } else {
                firebaseConfig = manualConfig;
                window.getCollectionRef = () => collection(db, 'allocations');
                window.getSettingsRef = () => collection(db, 'settings');
            }

            if (firebaseConfig.apiKey) {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                        else await signInAnonymously(auth);
                    } catch (error) { console.error("Auth Failed", error); }
                };
                initAuth();
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        isFirebaseActive = true;
                        document.getElementById('db-status').innerText = "Online ‚óè";
                        document.getElementById('db-status').style.color = "#30D158";
                        startRealtimeListener();
                        loadSettings();
                        loadUsers();
                    }
                });
            }
        } catch (e) { console.error("Init Error", e); }

        window.DB = { allocations: [] }; 
        window.SETTINGS = { formats: [], journalists: [], sales: [], teams: [] };
        window.USERS = {};
        window.SESSION = { user: null, role: null };
        window.TEMP = { allocId: null, slotTime: null };

        function getLocalDateString(offsetDays = 0) {
            const d = new Date();
            d.setDate(d.getDate() + offsetDays);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function startRealtimeListener() {
            if(!isFirebaseActive) return;
            onSnapshot(window.getCollectionRef(), (snapshot) => {
                const loaded = [];
                snapshot.forEach((doc) => loaded.push({ id: doc.id, ...doc.data() }));
                window.DB.allocations = loaded;
                
                if(document.getElementById('dashboard-view').classList.contains('active')) loadDashboard();
                else if (document.getElementById('production-notes-view').classList.contains('active')) renderProductionNotes();
                else if (document.getElementById('editing-queue-view').classList.contains('active')) renderEditingQueue();
                else if (document.getElementById('editing-archive-view').classList.contains('active')) renderEditingArchive();
                else if (document.getElementById('slots-view').classList.contains('active') && window.TEMP.allocId) {
                    const current = window.DB.allocations.find(a => a.id === window.TEMP.allocId);
                    if(current) renderSlots(current); else goToDashboard();
                }
            });
        }

        window.handleLogin = () => {
            const user = document.getElementById('username').value.trim().toLowerCase().replace(/\s/g, ''); 
            const pass = document.getElementById('password').value;
            const userData = window.USERS[user];
            if (userData && userData.password === pass) {
                window.SESSION.user = user;
                window.SESSION.role = userData.role;
                switchView('dashboard-view');
                loadDashboard();
            } else {
                document.getElementById('login-msg').innerText = "Credenziali errate.";
            }
        };

        window.handleLogout = () => location.reload();

        function switchView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function loadDashboard() {
            const userData = window.USERS[window.SESSION.user];
            document.getElementById('user-welcome').innerText = userData ? userData.label : window.SESSION.user;
            document.getElementById('user-badge').innerText = window.SESSION.role;
            document.getElementById('admin-tools').style.display = window.SESSION.role === 'ADMIN' ? 'block' : 'none';
            renderGrid();
        }

        function renderGrid() {
            const grid = document.getElementById('grid-dates');
            grid.innerHTML = '';
            const yesterday = getLocalDateString(-1); 
            const myAllocations = window.DB.allocations.filter(a => {
                if (window.SESSION.role === 'ADMIN') return true;
                return a.team === window.SESSION.user;
            }).filter(a => a.date >= yesterday);
            myAllocations.sort((a, b) => new Date(a.date) - new Date(b.date));
            if (myAllocations.length === 0) grid.innerHTML = '<div style="opacity:0.5; padding:20px;">Nessuna data disponibile.</div>';
            myAllocations.forEach(alloc => createCard(alloc, grid));
        }

        function createCard(alloc, container) {
            const teamData = window.USERS[alloc.team] || { label: alloc.team, color: '#888' };
            const d = new Date(alloc.date);
            const card = document.createElement('div');
            card.className = `date-card glass-panel`;
            card.style.borderLeft = `5px solid ${teamData.color}`;
            card.onclick = () => window.openDetails(alloc.id);
            card.innerHTML = `
                ${window.SESSION.role === 'ADMIN' ? `<button onclick="event.stopPropagation(); deleteAlloc('${alloc.id}')" style="position:absolute; top:10px; right:10px; background:none; border:none; color:#555; font-size:20px;">&times;</button>` : ''}
                <div style="font-size:13px; text-transform:uppercase; color:#888;">${teamData.label}</div>
                <div style="font-size:22px; font-weight:700; margin:5px 0;">${d.getDate()} ${d.toLocaleString('it-IT',{month:'long'})}</div>
                <div style="font-size:13px; margin-top:10px; color:#fff;">${alloc.slots.filter(s => !s.booked).length} slot liberi</div>
            `;
            container.appendChild(card);
        }

        window.openDetails = (allocId) => {
            window.TEMP.allocId = allocId;
            const alloc = window.DB.allocations.find(a => a.id === allocId);
            if(alloc) {
                switchView('slots-view');
                document.getElementById('slot-date-title').innerText = alloc.date;
                document.getElementById('slot-team-subtitle').innerText = window.USERS[alloc.team]?.label || alloc.team;
                renderSlots(alloc);
            }
        };

        function renderSlots(alloc) {
            const list = document.getElementById('slots-container');
            list.innerHTML = '';
            const teamData = window.USERS[alloc.team] || { color: '#007AFF' };
            alloc.slots.forEach(slot => {
                const row = document.createElement('div');
                row.className = `slot-item ${slot.booked ? 'slot-booked' : 'slot-free'}`;
                if (slot.booked) {
                    row.innerHTML = `
                        <div style="display:flex; align-items:center;">
                            <div style="font-weight:bold; width:60px;">${slot.time}</div>
                            <div style="margin-left:15px;">
                                <div style="font-weight:bold;">${slot.info.guest}</div>
                                <div style="font-size:12px; opacity:0.7;">${slot.info.company || ''}</div>
                                <div style="font-size:11px; margin-top:4px;"><span style="color:${teamData.color}">‚óè</span> ${slot.info.jour}</div>
                            </div>
                        </div>
                        <button class="btn btn-secondary" style="font-size:11px;" onclick="editBooking('${slot.time}')">‚úé Modifica</button>
                    `;
                } else {
                    row.innerHTML = `
                        <div style="display:flex; align-items:center;">
                            <div style="font-weight:bold; width:60px;">${slot.time}</div>
                            <div style="margin-left:15px; opacity:0.5;">Disponibile</div>
                        </div>
                        <button class="btn btn-primary" style="font-size:11px;" onclick="openModal('${slot.time}')">Prenota</button>
                    `;
                }
                list.appendChild(row);
            });
        }

        window.openProductionNotes = () => { switchView('production-notes-view'); renderProductionNotes(); };

        function renderProductionNotes() {
            const container = document.getElementById('notes-list');
            container.innerHTML = '';
            const todayStr = getLocalDateString(0); 
            const todayAllocations = window.DB.allocations.filter(a => a.date === todayStr);
            let allSlots = [];

            todayAllocations.forEach(alloc => {
                alloc.slots.forEach(slot => {
                    // Mostra solo se prenotato E NON √® ancora in editing o archivio
                    if (slot.booked && (!slot.info.status || slot.info.status === 'scheduled')) {
                        allSlots.push({ ...slot, allocId: alloc.id, team: alloc.team });
                    }
                });
            });

            allSlots.sort((a, b) => a.time.localeCompare(b.time));

            if (allSlots.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#888;">Nessuna intervista attiva per oggi.</div>';
                return;
            }

            allSlots.forEach(item => {
                const cleanName = (item.info.guest || '').toLowerCase().replace(/[^a-z0-9]/g, '');
                const cleanComp = (item.info.company || '').toLowerCase().replace(/[^a-z0-9]/g, '');
                const filename = `${cleanName}_${cleanComp}`;

                const div = document.createElement('div');
                div.className = 'note-item';
                div.innerHTML = `
                    <div style="font-weight:bold; color:#FFD60A;">${item.time}</div>
                    <div>
                        <div style="font-weight:bold; display:flex; align-items:center; gap:8px;">
                            ${item.info.guest} 
                            <button onclick="openProdNoteModal('${item.allocId}', '${item.time}')" style="background:#333; border:1px solid #555; cursor:pointer; color:#00C7BE; border-radius:4px; padding:2px 6px; font-size:11px;" title="Aggiungi Note">‚úé Note Produzione</button>
                        </div>
                        <div style="font-size:12px; opacity:0.7;">${item.info.company || ''}</div>
                        ${item.info.productionNotes ? `<div style="font-size:11px; color:#00C7BE; margin-top:5px; background:rgba(0,199,190,0.1); padding:5px; border-radius:4px;"><strong>Note:</strong> ${item.info.productionNotes}</div>` : ''}
                    </div>
                    <div style="font-size:13px; color:#aaa;">${item.info.format || '-'}</div>
                    <div style="font-size:13px;">${item.info.jour || '-'}</div>
                    <div style="font-size:11px; text-transform:uppercase; text-align:center;">${item.info.type}</div>
                    <div style="text-align:center; display:flex; gap:5px; justify-content:center;">
                        <button class="btn btn-secondary" style="padding:6px; font-size:10px;" onclick="copyToClipboard('${filename}')" title="Copia nome file">Copia Nome File</button>
                        <button class="btn btn-danger" style="padding:6px; font-size:10px;" onclick="sendToEditing('${item.allocId}', '${item.time}', this)">DA MONTARE</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        window.openProdNoteModal = (allocId, time) => {
            window.TEMP.noteTarget = { allocId, time };
            const alloc = window.DB.allocations.find(a => a.id === allocId);
            const slot = alloc.slots.find(s => s.time === time);
            document.getElementById('prod-note-text').value = slot.info.productionNotes || '';
            document.getElementById('prod-note-modal').style.display = 'flex';
        };

        window.saveProdNote = async () => {
            const { allocId, time } = window.TEMP.noteTarget;
            const note = document.getElementById('prod-note-text').value;
            const alloc = window.DB.allocations.find(a => a.id === allocId);
            const newSlots = [...alloc.slots];
            const idx = newSlots.findIndex(s => s.time === time);
            newSlots[idx].info.productionNotes = note;
            await updateDoc(doc(window.getCollectionRef(), allocId), { slots: newSlots });
            document.getElementById('prod-note-modal').style.display = 'none';
        };

        window.sendToEditing = async (allocId, time, btn) => {
            if(!confirm("Confermi fine intervista? Sposter√† il file in coda di montaggio.")) return;
            btn.style.backgroundColor = 'red'; btn.style.color = 'white';
            setTimeout(async () => {
                const alloc = window.DB.allocations.find(a => a.id === allocId);
                const newSlots = [...alloc.slots];
                const idx = newSlots.findIndex(s => s.time === time);
                newSlots[idx].info.status = 'editing_queue'; 
                newSlots[idx].info.movedToEditingAt = new Date().toISOString();
                await updateDoc(doc(window.getCollectionRef(), allocId), { slots: newSlots });
            }, 500);
        };

        window.openEditingQueue = () => { switchView('editing-queue-view'); renderEditingQueue(); };

        function renderEditingQueue() {
            const container = document.getElementById('editing-list');
            container.innerHTML = '';
            let allItems = [];
            window.DB.allocations.forEach(alloc => {
                if (window.SESSION.role !== 'ADMIN' && alloc.team !== window.SESSION.user) return;
                alloc.slots.forEach(slot => {
                    if (slot.booked && ['editing_queue', 'waiting', 'ready'].includes(slot.info.status)) {
                        allItems.push({ ...slot, allocId: alloc.id, date: alloc.date });
                    }
                });
            });
            allItems.sort((a, b) => new Date(b.info.movedToEditingAt || 0) - new Date(a.info.movedToEditingAt || 0));
            if (allItems.length === 0) { container.innerHTML = '<div style="text-align:center; opacity:0.5; padding:40px;">Coda di montaggio vuota.</div>'; return; }
            allItems.forEach(item => {
                const statusMap = { 'editing_queue': { label: 'DA MONTARE', class: 'status-queue' }, 'waiting': { label: 'IN ATTESA', class: 'status-waiting' }, 'ready': { label: 'PRONTO', class: 'status-ready' } };
                const st = statusMap[item.info.status];
                
                const strName = `${item.info.guest} - ${item.info.company || ''}`;
                const strLower = `${item.info.guest}\n${item.info.job || ''}`;
                const safeStrName = strName.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                const safeStrLower = strLower.replace(/'/g, "\\'").replace(/"/g, "&quot;").replace(/\n/g, "\\n");

                const div = document.createElement('div');
                div.className = 'edit-item';
                div.innerHTML = `
                    <div class="edit-header">
                        <div><div style="font-weight:bold; font-size:16px;">${item.date} | ${item.time}</div><div style="font-size:12px; opacity:0.6;">Format: ${item.info.format || '-'}</div></div>
                        <div class="status-badge ${st.class}">${st.label}</div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div class="copy-box" onclick="copyToClipboard('${safeStrName}')">${strName}</div>
                        <div class="copy-box" onclick="copyToClipboard('${safeStrLower}')">${strLower.replace(/\n/g, '<br>')}</div>
                    </div>
                    ${item.info.productionNotes ? `<div style="margin-top:10px; background:rgba(0,0,0,0.3); padding:10px; border-radius:8px; font-size:12px; color:#ccc;"><strong>Note di Regia:</strong> ${item.info.productionNotes}</div>` : ''}
                    ${window.SESSION.role === 'ADMIN' ? `
                        <div style="margin-top:15px; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
                            <button class="btn btn-danger" style="font-size:10px; padding:6px;" onclick="updateStatus('${item.allocId}', '${item.time}', 'editing_queue')">Da Montare</button>
                            <button class="btn btn-secondary" style="font-size:10px; padding:6px; color:#FFD60A; border-color:#FFD60A;" onclick="updateStatus('${item.allocId}', '${item.time}', 'waiting')">In Attesa</button>
                            <button class="btn btn-success" style="font-size:10px; padding:6px;" onclick="updateStatus('${item.allocId}', '${item.time}', 'ready')">Pronto</button>
                            <button class="btn btn-secondary" style="font-size:10px; padding:6px; margin-left:10px;" onclick="updateStatus('${item.allocId}', '${item.time}', 'archived_editing')">üì¶ Archivia</button>
                        </div>
                    ` : ''}
                `;
                container.appendChild(div);
            });
        }

        window.openEditingArchive = () => { switchView('editing-archive-view'); renderEditingArchive(); };

        function renderEditingArchive() {
            const container = document.getElementById('editing-archive-list');
            container.innerHTML = '';
            let allItems = [];
            window.DB.allocations.forEach(alloc => {
                if (window.SESSION.role !== 'ADMIN' && alloc.team !== window.SESSION.user) return;
                alloc.slots.forEach(slot => {
                    if (slot.booked && slot.info.status === 'archived_editing') {
                        allItems.push({ ...slot, allocId: alloc.id, date: alloc.date });
                    }
                });
            });
            allItems.sort((a, b) => new Date(b.info.updatedAt || 0) - new Date(a.info.updatedAt || 0));

            if (allItems.length === 0) { container.innerHTML = '<div style="text-align:center; opacity:0.5; padding:40px;">Archivio montaggi vuoto.</div>'; return; }

            allItems.forEach(item => {
                const strName = `${item.info.guest} - ${item.info.company || ''}`;
                const div = document.createElement('div');
                div.className = 'edit-item';
                div.style.opacity = "0.7"; 
                div.innerHTML = `
                    <div class="edit-header">
                        <div><div style="font-weight:bold; font-size:16px;">${item.date} | ${item.time}</div><div style="font-size:12px; opacity:0.6;">${strName}</div></div>
                        <div class="status-badge status-archived">ARCHIVIATO</div>
                    </div>
                    ${window.SESSION.role === 'ADMIN' ? `
                        <div style="margin-top:10px; text-align:right;">
                            <button class="btn btn-secondary" style="font-size:10px; padding:6px;" onclick="updateStatus('${item.allocId}', '${item.time}', 'ready')">‚Ü∫ Ripristina in Coda</button>
                        </div>
                    ` : ''}
                `;
                container.appendChild(div);
            });
        }

        window.updateStatus = async (allocId, time, newStatus) => {
            const alloc = window.DB.allocations.find(a => a.id === allocId);
            const newSlots = [...alloc.slots];
            const idx = newSlots.findIndex(s => s.time === time);
            newSlots[idx].info.status = newStatus;
            newSlots[idx].info.updatedAt = new Date().toISOString(); 
            await updateDoc(doc(window.getCollectionRef(), allocId), { slots: newSlots });
        };

        window.createAllocation = async () => {
            const date = document.getElementById('new-date').value;
            const team = document.getElementById('new-team').value;
            const start = document.getElementById('start-time').value;
            const end = document.getElementById('end-time').value;
            if(!date || !start || !end) return alert("Dati mancanti");
            let slots = [];
            let [h, m] = start.split(':').map(Number);
            let [eh, em] = end.split(':').map(Number);
            let cur = h * 60 + m;
            let endM = eh * 60 + em;
            while(cur < endM) {
                let hh = Math.floor(cur / 60).toString().padStart(2,'0');
                let mm = (cur % 60).toString().padStart(2,'0');
                slots.push({ time: `${hh}:${mm}`, booked: false, info: {} });
                cur += 30;
            }
            await addDoc(window.getCollectionRef(), { date, team, slots, createdAt: new Date().toISOString() });
            alert("Data creata!");
        };

        window.deleteAlloc = async (id) => { if(confirm("Eliminare data?")) await deleteDoc(doc(window.getCollectionRef(), id)); };

        window.openModal = (time) => {
            window.TEMP.slotTime = time;
            document.getElementById('booking-modal').style.display = 'flex';
            document.getElementById('modal-time').innerText = time;
            document.getElementById('modal-title-action').innerText = "Prenota";
            document.getElementById('btn-delete').style.display = 'none';
            ['b-name','b-company','b-job','b-note'].forEach(id => document.getElementById(id).value = '');
            populateSelect('b-format', window.SETTINGS.formats, '');
            populateSelect('b-jour', window.SETTINGS.journalists, '');
            populateSelect('b-sales', window.SETTINGS.sales, '');
            document.getElementById('b-type').value = 'Presenza';
        };

        window.editBooking = (time) => {
            window.TEMP.slotTime = time;
            const alloc = window.DB.allocations.find(a => a.id === window.TEMP.allocId);
            const slot = alloc.slots.find(s => s.time === time);
            document.getElementById('booking-modal').style.display = 'flex';
            document.getElementById('modal-time').innerText = time;
            document.getElementById('modal-title-action').innerText = "Modifica";
            document.getElementById('btn-delete').style.display = 'inline-block';
            const i = slot.info;
            document.getElementById('b-name').value = i.guest || '';
            document.getElementById('b-company').value = i.company || '';
            document.getElementById('b-job').value = i.job || '';
            document.getElementById('b-type').value = i.type || 'Presenza';
            document.getElementById('b-note').value = i.note || '';
            populateSelect('b-format', window.SETTINGS.formats, i.format);
            populateSelect('b-jour', window.SETTINGS.journalists, i.jour);
            populateSelect('b-sales', window.SETTINGS.sales, i.sales);
        };

        window.closeModal = () => document.getElementById('booking-modal').style.display = 'none';

        window.saveBooking = async () => {
            const alloc = window.DB.allocations.find(a => a.id === window.TEMP.allocId);
            const newSlots = [...alloc.slots];
            const idx = newSlots.findIndex(s => s.time === window.TEMP.slotTime);
            const info = {
                guest: document.getElementById('b-name').value,
                company: document.getElementById('b-company').value,
                job: document.getElementById('b-job').value,
                format: document.getElementById('b-format').value,
                jour: document.getElementById('b-jour').value,
                sales: document.getElementById('b-sales').value,
                type: document.getElementById('b-type').value,
                note: document.getElementById('b-note').value,
                status: newSlots[idx].booked ? newSlots[idx].info.status : 'scheduled',
                productionNotes: newSlots[idx].booked ? newSlots[idx].info.productionNotes : '',
                updatedAt: new Date().toISOString()
            };
            if(!info.guest) return alert("Inserire nome ospite");
            newSlots[idx] = { time: window.TEMP.slotTime, booked: true, info: info };
            await updateDoc(doc(window.getCollectionRef(), alloc.id), { slots: newSlots });
            closeModal();
        };

        window.deleteFromModal = async () => {
            if(!confirm("Eliminare appuntamento?")) return;
            const alloc = window.DB.allocations.find(a => a.id === window.TEMP.allocId);
            const newSlots = [...alloc.slots];
            const idx = newSlots.findIndex(s => s.time === window.TEMP.slotTime);
            newSlots[idx] = { time: window.TEMP.slotTime, booked: false, info: {} };
            await updateDoc(doc(window.getCollectionRef(), alloc.id), { slots: newSlots });
            closeModal();
        };

        // --- GESTIONE UTENTI & LISTE ---
        window.openSettings = () => {
            document.getElementById('settings-modal').style.display = 'flex';
            // Liste
            document.getElementById('set-teams').value = (window.SETTINGS.teams || []).join('\n'); // NUOVO
            document.getElementById('set-formats').value = (window.SETTINGS.formats || []).join('\n');
            document.getElementById('set-jours').value = (window.SETTINGS.journalists || []).join('\n');
            document.getElementById('set-sales').value = (window.SETTINGS.sales || []).join('\n');
            // Utenti
            renderUsersList();
        };
        window.closeSettings = () => document.getElementById('settings-modal').style.display = 'none';
        
        window.saveSettings = async () => {
            const teams = document.getElementById('set-teams').value.split('\n').map(s=>s.trim()).filter(s=>s);
            const formats = document.getElementById('set-formats').value.split('\n').map(s=>s.trim()).filter(s=>s);
            const journalists = document.getElementById('set-jours').value.split('\n').map(s=>s.trim()).filter(s=>s);
            const sales = document.getElementById('set-sales').value.split('\n').map(s=>s.trim()).filter(s=>s);
            await setDoc(doc(window.getSettingsRef(), 'lists'), { teams, formats, journalists, sales });
            closeSettings(); // CHIUSURA AUTOMATICA AGGIUNTA
            alert("Liste salvate!");
        };

        window.openUserManager = () => { document.getElementById('users-modal').style.display = 'flex'; renderUsersList(); };
        window.closeUserManager = () => document.getElementById('users-modal').style.display = 'none';
        
        function renderUsersList() {
            const c = document.getElementById('users-list-container'); c.innerHTML = '';
            Object.keys(window.USERS).forEach(u => {
                c.innerHTML += `<div class="user-list-item"><div><span style="background:${window.USERS[u].color};width:10px;height:10px;display:inline-block;border-radius:50%;"></span> ${u}</div>${u!=='admin'?`<button class="btn btn-danger" style="font-size:10px;padding:4px;" onclick="deleteUser('${u}')">X</button>`:''}</div>`;
            });
        }

        window.saveUserConfig = async () => {
            const u = document.getElementById('u-user').value.toLowerCase().replace(/\s/g,'');
            const p = document.getElementById('u-pass').value;
            const l = document.getElementById('u-label').value;
            const c = document.getElementById('u-color').value;
            if(!u || !p) return alert("Dati mancanti");
            window.USERS[u] = { password: p, label: l, color: c, role: u==='admin'?'ADMIN':'EDITOR' };
            await setDoc(doc(window.getSettingsRef(), 'users'), window.USERS);
            renderUsersList();
            document.getElementById('u-user').value=''; document.getElementById('u-pass').value=''; document.getElementById('u-label').value='';
        };

        window.deleteUser = async (u) => {
            if(confirm("Eliminare?")) { delete window.USERS[u]; await setDoc(doc(window.getSettingsRef(), 'users'), window.USERS); renderUsersList(); }
        };

        function loadSettings() {
            if(!isFirebaseActive) return;
            onSnapshot(doc(window.getSettingsRef(), 'lists'), (s) => { 
                if(s.exists()) {
                    window.SETTINGS = s.data();
                    if(window.SESSION.role === 'ADMIN') populateTeamSelect(); // Update dropdown
                }
            });
        }
        function loadUsers() {
            if(!isFirebaseActive) return;
            onSnapshot(doc(window.getSettingsRef(), 'users'), (s) => { 
                if(s.exists()) window.USERS = s.data(); 
                else setDoc(doc(window.getSettingsRef(), 'users'), window.USERS);
            });
        }

        window.openArchive = () => { switchView('archive-view'); renderArchiveGrid(); };
        function renderArchiveGrid() {
            const grid = document.getElementById('grid-archive'); grid.innerHTML = '';
            const y = getLocalDateString(0); // FIX: Usa "Oggi" come limite superiore per l'archivio (quindi < Oggi)
            const arch = window.DB.allocations.filter(a => a.date < y).sort((a,b)=>new Date(b.date)-new Date(a.date));
            if(arch.length===0) grid.innerHTML='<div style="padding:20px;opacity:0.5;">Archivio vuoto</div>';
            arch.forEach(a => createCard(a, grid));
        }
        window.goToDashboard = () => { switchView('dashboard-view'); loadDashboard(); };
        window.copyToClipboard = (txt) => {
            const el = document.createElement('textarea'); el.value = txt; document.body.appendChild(el);
            el.select(); document.execCommand('copy'); document.body.removeChild(el); alert("Copiato!");
        };
        function populateSelect(id, items, sel) {
            const el = document.getElementById(id); el.innerHTML = '<option value="">Seleziona...</option>';
            (items||[]).forEach(i => {
                const opt = document.createElement('option'); opt.value=i; opt.innerText=i; if(i===sel) opt.selected=true;
                el.appendChild(opt);
            });
        }
        function populateTeamSelect() {
            const s = document.getElementById('new-team'); s.innerHTML='';
            Object.keys(window.USERS).forEach(u => { if(window.USERS[u].role!=='ADMIN') {
                const o = document.createElement('option'); o.value=u; o.innerText=window.USERS[u].label; s.appendChild(o);
            }});
        }
    </script>
</body>
</html>